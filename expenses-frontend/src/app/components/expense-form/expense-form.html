<div class="expense-form-container">
  <!-- Expenses Overview -->
  <div class="expenses-overview-card">
    <h2>Expenses Overview</h2>
    
    @if (loadingExpenses()) {
      <div class="loading-message">Loading expenses...</div>
    } @else if (expenses().length === 0) {
      <div class="empty-message">No expenses yet. Add your first expense below!</div>
    } @else {
      <div class="expenses-table-container">
        <table class="expenses-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Category</th>
              <th class="amount-col">Amount</th>
            </tr>
          </thead>
          <tbody>
            @for (expense of expenses(); track expense.id) {
              <tr>
                <td>{{ formatDate(expense.date) }}</td>
                <td>{{ expense.description }}</td>
                <td>
                  <span class="category-badge">{{ expense.categoryName || 'N/A' }}</span>
                </td>
                <td class="amount-col">{{ formatCurrency(expense.amount) }}</td>
              </tr>
            }
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td colspan="3"><strong>Total</strong></td>
              <td class="amount-col">
                <strong>{{ formatCurrency(getTotalAmount()) }}</strong>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    }
  </div>

  <!-- Add Expense Form -->
  <div class="form-card">
    <h2>Add New Expense</h2>

    <form (ngSubmit)="submitExpense()" class="expense-form">
      <!-- Description -->
      <div class="form-group">
        <label for="description">Description *</label>
        <input
          type="text"
          id="description"
          [value]="description()"
          (input)="description.set($any($event.target).value)"
          placeholder="Enter expense description"
          required
        />
      </div>

      <!-- Amount -->
      <div class="form-group">
        <label for="amount">Amount *</label>
        <input
          type="number"
          id="amount"
          step="0.01"
          min="0.01"
          [value]="amount()"
          (input)="onAmountChange($event)"
          placeholder="0.00"
          required
        />
      </div>

      <!-- Date -->
      <div class="form-group">
        <label for="date">Date *</label>
        <input
          type="date"
          id="date"
          [value]="date()"
          (input)="date.set($any($event.target).value)"
          required
        />
      </div>

      <!-- Category Search -->
      <div class="form-group">
        <label for="category">Category *</label>
        <div class="category-search-container">
          <input
            type="text"
            id="category"
            [value]="categorySearch()"
            (input)="categorySearch.set($any($event.target).value); onCategorySearch()"
            placeholder="Search or type new category"
            autocomplete="off"
            required
          />
          
          <!-- Category Suggestions Dropdown -->
          @if (categorySearch() && filteredCategories().length > 0 && !selectedCategory) {
            <div class="category-dropdown">
              @for (category of filteredCategories(); track category.id) {
                <div
                  class="category-option"
                  (click)="selectCategory(category)"
                >
                  {{ category.name }}
                </div>
              }
            </div>
          }

          <!-- Create New Category Option -->
          @if (showCreateCategory()) {
            <div class="create-category-prompt">
              <p>Category "{{ newCategoryName() }}" not found.</p>
              <button
                type="button"
                class="btn-create-category"
                (click)="createCategoryAndExpense()"
                [disabled]="loading()"
              >
                Create Category & Add Expense
              </button>
            </div>
          }

          <!-- Selected Category Display -->
          @if (selectedCategory) {
            <div class="selected-category">
              <span>Selected: <strong>{{ selectedCategory.name }}</strong></span>
              <button
                type="button"
                class="btn-clear"
                (click)="selectedCategory = null; categorySearch.set(''); onCategorySearch()"
              >
                Clear
              </button>
            </div>
          }
        </div>
      </div>

      <!-- Error Message -->
      @if (error()) {
        <div class="alert alert-error">
          {{ error() }}
        </div>
      }

      <!-- Success Message -->
      @if (success()) {
        <div class="alert alert-success">
          Expense added successfully!
        </div>
      }

      <!-- Submit Button -->
      <button
        type="submit"
        class="btn-submit"
        [disabled]="loading() || !selectedCategory && !showCreateCategory()"
      >
        @if (loading()) {
          <span>Adding...</span>
        } @else {
          <span>Add Expense</span>
        }
      </button>
    </form>
  </div>
</div>

